# ä»£ç æ¶æ„è¯´æ˜æ–‡æ¡£

ç”Ÿæˆæ—¶é—´: 2025-10-08

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
3. [æ ¸å¿ƒæ¨¡å—è¯´æ˜](#æ ¸å¿ƒæ¨¡å—è¯´æ˜)
4. [æ•°æ®æµè¯´æ˜](#æ•°æ®æµè¯´æ˜)
5. [é‡æ„æ”¹è¿›ç‚¹](#é‡æ„æ”¹è¿›ç‚¹)
6. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)

---

## ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäºFastAPIçš„æ–‡æ¡£æ™ºèƒ½å¤„ç†å¹³å°ï¼Œé›†æˆäº†ä¸‰ä¸ªæ ¸å¿ƒAIæœåŠ¡ï¼š

1. **æ–‡æ¡£ä¼˜åŒ–æœåŠ¡** (Final Review Agent) - æ£€æµ‹å¹¶ä¼˜åŒ–æ–‡æ¡£ä¸­çš„å†—ä½™å†…å®¹
2. **è®ºç‚¹ä¸€è‡´æ€§æ£€æŸ¥æœåŠ¡** (Thesis Agent) - ç¡®ä¿æ–‡æ¡£è®ºç‚¹çš„ä¸€è‡´æ€§
3. **è®ºæ®æ”¯æŒåº¦è¯„ä¼°æœåŠ¡** (Web Agent) - é€šè¿‡ç½‘ç»œæœç´¢ä¸ºè®ºæ–­æä¾›è¯æ®æ”¯æŒ

ç³»ç»Ÿé‡‡ç”¨**ç»Ÿä¸€è·¯ç”± + ç‹¬ç«‹ä¸šåŠ¡æ¨¡å—**çš„æ¶æ„ï¼Œæ‰€æœ‰æœåŠ¡é€šè¿‡ç»Ÿä¸€çš„APIç½‘å…³å¯¹å¤–æä¾›æœåŠ¡ã€‚

---

## æ•´ä½“æ¶æ„

### ç›®å½•ç»“æ„

```
review_agent_save/
â”‚
â”œâ”€â”€ shared/                              # ã€æ–°å¢ã€‘å…±äº«æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py                      # æ¨¡å—å¯¼å‡º
â”‚   â”œâ”€â”€ exceptions.py                    # ç»Ÿä¸€å¼‚å¸¸å®šä¹‰
â”‚   â”œâ”€â”€ task_manager.py                  # ç»Ÿä¸€ä»»åŠ¡ç®¡ç†
â”‚   â”œâ”€â”€ document_parser.py               # ç»Ÿä¸€æ–‡æ¡£è§£æ
â”‚   â”œâ”€â”€ json_merger.py                   # ç»Ÿä¸€JSONåˆå¹¶å™¨
â”‚   â””â”€â”€ api_client_factory.py            # ç»Ÿä¸€APIå®¢æˆ·ç«¯å·¥å‚
â”‚
â”œâ”€â”€ router/                              # ç»Ÿä¸€è·¯ç”±å±‚
â”‚   â”œâ”€â”€ main.py                          # FastAPIä¸»åº”ç”¨
â”‚   â”œâ”€â”€ config.py                        # ç»Ÿä¸€é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ start_server.py                  # æœåŠ¡å¯åŠ¨è„šæœ¬
â”‚   â””â”€â”€ routers/                         # è·¯ç”±æ¨¡å—
â”‚       â”œâ”€â”€ final_review_router.py       # æ–‡æ¡£ä¼˜åŒ–è·¯ç”±
â”‚       â”œâ”€â”€ thesis_agent_router.py       # è®ºç‚¹ä¸€è‡´æ€§è·¯ç”±
â”‚       â””â”€â”€ web_agent_router.py          # è®ºæ®æ”¯æŒåº¦è·¯ç”±
â”‚
â”œâ”€â”€ final_review_agent_app/              # æ–‡æ¡£ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ run_document_optimizer.py        # æ–‡æ¡£ä¼˜åŒ–å™¨
â”‚   â”œâ”€â”€ document_reviewer.py             # æ–‡æ¡£å®¡æŸ¥å™¨
â”‚   â”œâ”€â”€ document_modifier.py             # æ–‡æ¡£ä¿®æ”¹å™¨
â”‚   â”œâ”€â”€ task_manager.py                  # ä»»åŠ¡ç¼–æ’å™¨
â”‚   â””â”€â”€ models.py                        # æ•°æ®æ¨¡å‹
â”‚
â”œâ”€â”€ thesis_agent_app/                    # è®ºç‚¹ä¸€è‡´æ€§ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ run_thesis_checker.py            # è®ºç‚¹æ£€æŸ¥æµæ°´çº¿
â”‚   â”œâ”€â”€ thesis_extractor.py              # è®ºç‚¹æå–å™¨
â”‚   â”œâ”€â”€ thesis_consistency_checker.py    # ä¸€è‡´æ€§æ£€æŸ¥å™¨
â”‚   â””â”€â”€ document_regenerator.py          # æ–‡æ¡£é‡ç”Ÿæˆå™¨
â”‚
â””â”€â”€ web_agent_app/                       # è®ºæ®æ”¯æŒåº¦ä¸šåŠ¡é€»è¾‘
    â”œâ”€â”€ whole_document_pipeline.py       # å®Œæ•´æ–‡æ¡£æµæ°´çº¿
    â”œâ”€â”€ evidence_detector.py             # è¯æ®æ£€æµ‹å™¨
    â”œâ”€â”€ web_search_agent.py              # ç½‘ç»œæœç´¢ä»£ç†
    â””â”€â”€ direct_document_merger.py        # æ–‡æ¡£åˆå¹¶å™¨
```

### æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¢æˆ·ç«¯ (HTTP/JSON)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç»Ÿä¸€è·¯ç”±å±‚ (router/main.py)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Final Review â”‚ Thesis Agent â”‚  Web Agent   â”‚         â”‚
â”‚  â”‚   Router     â”‚    Router    â”‚   Router     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å…±äº«æ¨¡å— (shared/)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Task       â”‚ Document   â”‚ JSON       â”‚ API Client  â”‚ â”‚
â”‚  â”‚ Manager    â”‚ Parser     â”‚ Merger     â”‚ Factory     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            Exceptions (ç»Ÿä¸€å¼‚å¸¸å¤„ç†)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ä¸šåŠ¡é€»è¾‘å±‚ (agent_app/)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Final Review â”‚ Thesis Agent â”‚  Web Agent   â”‚         â”‚
â”‚  â”‚     App      â”‚     App      â”‚     App      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¤–éƒ¨æœåŠ¡ (OpenRouter AI API)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ¨¡å—è¯´æ˜

### 1. å…±äº«æ¨¡å— (shared/)

å…±äº«æ¨¡å—æ˜¯æœ¬æ¬¡é‡æ„çš„æ ¸å¿ƒæˆæœï¼Œæå–äº†æ‰€æœ‰ä¸‰ä¸ªæœåŠ¡çš„å…¬å…±ä»£ç ï¼Œé¿å…é‡å¤ã€‚

#### 1.1 exceptions.py - ç»Ÿä¸€å¼‚å¸¸å®šä¹‰

**åŠŸèƒ½**: å®šä¹‰æ‰€æœ‰ä¸šåŠ¡å¼‚å¸¸ï¼Œæ›¿ä»£fallbackæœºåˆ¶ã€‚

**æ ¸å¿ƒå¼‚å¸¸ç±»**:
```python
AgentBaseException          # åŸºç¡€å¼‚å¸¸ç±»
â”œâ”€â”€ LLMCallError           # LLM APIè°ƒç”¨å¤±è´¥
â”œâ”€â”€ DocumentAnalysisError  # æ–‡æ¡£åˆ†æå¤±è´¥
â”œâ”€â”€ DocumentParseError     # æ–‡æ¡£è§£æå¤±è´¥
â”œâ”€â”€ EvidenceSearchError    # è¯æ®æœç´¢å¤±è´¥
â”œâ”€â”€ SectionGenerationError # ç« èŠ‚ç”Ÿæˆå¤±è´¥
â”œâ”€â”€ ThesisExtractionError  # è®ºç‚¹æå–å¤±è´¥
â””â”€â”€ ConsistencyCheckError  # ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥
```

**è®¾è®¡åŸåˆ™**: 
- æ‰€æœ‰é”™è¯¯éƒ½é€šè¿‡å¼‚å¸¸æ˜ç¡®æŠ¥å‘Šï¼Œä¸è¿”å›é»˜è®¤å€¼
- å¼‚å¸¸åœ¨è·¯ç”±å±‚ç»Ÿä¸€æ•è·å’Œå¤„ç†
- ä¸ºä¸åŒç±»å‹çš„é”™è¯¯æä¾›æ˜ç¡®çš„å¼‚å¸¸ç±»å‹

#### 1.2 task_manager.py - ç»Ÿä¸€ä»»åŠ¡ç®¡ç†

**åŠŸèƒ½**: ç®¡ç†æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡çš„çŠ¶æ€è·Ÿè¸ªã€‚

**æ ¸å¿ƒç±»**:
- `TaskManager`: ä»»åŠ¡ç®¡ç†å™¨
  - `create_task(task_id)`: åˆ›å»ºæ–°ä»»åŠ¡
  - `update_task(task_id, **kwargs)`: æ›´æ–°ä»»åŠ¡çŠ¶æ€
  - `get_task(task_id)`: è·å–ä»»åŠ¡è¯¦æƒ…
  - `get_task_status(task_id)`: è·å–ä»»åŠ¡çŠ¶æ€ï¼ˆè¿”å›Pydanticæ¨¡å‹ï¼‰
  - `task_exists(task_id)`: æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å­˜åœ¨
  - `delete_task(task_id)`: åˆ é™¤ä»»åŠ¡
  - `clear_old_tasks(max_age_seconds)`: æ¸…ç†è¿‡æœŸä»»åŠ¡

- `TaskStatus`: ä»»åŠ¡çŠ¶æ€æ¨¡å‹
  - `task_id`: ä»»åŠ¡ID
  - `status`: çŠ¶æ€ (pending/processing/completed/failed)
  - `progress`: è¿›åº¦ (0.0-1.0)
  - `message`: çŠ¶æ€æ¶ˆæ¯
  - `result`: ä»»åŠ¡ç»“æœ
  - `error`: é”™è¯¯ä¿¡æ¯
  - `start_time/end_time`: æ—¶é—´æˆ³

**ä½¿ç”¨åœºæ™¯**: ä¸‰ä¸ªrouteréƒ½ä½¿ç”¨åŒä¸€ä¸ªTaskManagerå®ä¾‹ï¼Œç¡®ä¿ä»»åŠ¡çŠ¶æ€ç®¡ç†çš„ä¸€è‡´æ€§ã€‚

#### 1.3 document_parser.py - ç»Ÿä¸€æ–‡æ¡£è§£æ

**åŠŸèƒ½**: è§£æMarkdownæ–‡æ¡£çš„æ ‡é¢˜ç»“æ„ï¼Œæ”¯æŒ1-3çº§æ ‡é¢˜åµŒå¥—ã€‚

**æ ¸å¿ƒæ–¹æ³•**:
- `parse_sections(content, max_level=3, preserve_order=True)`: 
  - è§£ææ–‡æ¡£ä¸ºåµŒå¥—ç»“æ„: `{h1: {section_key: content}}`
  - `section_key` æ ¼å¼: `"h2"` æˆ– `"h2 > h3"`
  - æ”¯æŒä¿æŒç« èŠ‚é¡ºåº

- `parse_flat_sections(content, level=1)`: 
  - æ‰å¹³åŒ–è§£æï¼ŒæŒ‰æŒ‡å®šçº§åˆ«åˆ†å‰²
  - è¿”å›: `{section_title: section_content}`

- `extract_section_content(full_content, section_title, fuzzy_match=True)`:
  - ä»å®Œæ•´æ–‡æ¡£ä¸­æå–æŒ‡å®šç« èŠ‚
  - æ”¯æŒæ¨¡ç³ŠåŒ¹é…

**æ ‡é¢˜ç»“æ„ç¤ºä¾‹**:
```
# H1æ ‡é¢˜                  â† ä¸€çº§æ ‡é¢˜
## H2æ ‡é¢˜                â† äºŒçº§æ ‡é¢˜
### H3æ ‡é¢˜              â† ä¸‰çº§æ ‡é¢˜
å†…å®¹...

è§£æç»“æœ:
{
  "H1æ ‡é¢˜": {
    "H2æ ‡é¢˜ > H3æ ‡é¢˜": "å†…å®¹..."
  }
}
```

#### 1.4 json_merger.py - ç»Ÿä¸€JSONåˆå¹¶å™¨

**åŠŸèƒ½**: åœ¨JSONå±‚é¢è¿›è¡Œæ–‡æ¡£ç« èŠ‚æ›¿æ¢ï¼Œç„¶åè½¬æ¢ä¸ºMarkdownã€‚

**æ ¸å¿ƒç±»**:
- `JSONDocumentMerger`: JSONæ–‡æ¡£åˆå¹¶å™¨
  - `load_original_json()`: åŠ è½½åŸå§‹JSON
  - `load_regenerated_sections()`: åŠ è½½é‡æ–°ç”Ÿæˆçš„ç« èŠ‚
  - `find_section_in_json(section_title)`: åœ¨JSONä¸­æŸ¥æ‰¾ç« èŠ‚
  - `merge_json_documents()`: åˆå¹¶æ–‡æ¡£
  - `save_merged_json(merged_data, output_path)`: ä¿å­˜ç»“æœ
  - `convert_to_markdown(merged_data, output_path)`: è½¬æ¢ä¸ºMarkdown

- `SimpleMarkdownConverter`: Markdownè½¬æ¢å™¨
  - `convert_to_markdown(json_data)`: JSONè½¬Markdown

**æ ¸å¿ƒå‡½æ•°**:
- `update_json_sections_inplace(target_json_path, regenerated_json_path, correction_type)`:
  - ç›´æ¥æ›´æ–°JSONæ–‡ä»¶ä¸­çš„ç« èŠ‚å†…å®¹
  - ä¿ç•™åŸæœ‰çš„å›¾ç‰‡ã€è¡¨æ ¼ç­‰å…ƒæ•°æ®
  - åªæ›´æ–°`generated_content`å­—æ®µ

**ä½¿ç”¨åœºæ™¯**: Thesis Agentå’ŒFinal Review Agentéƒ½éœ€è¦åˆå¹¶æ–‡æ¡£ï¼Œä½¿ç”¨ç»Ÿä¸€çš„åˆå¹¶é€»è¾‘ã€‚

#### 1.5 api_client_factory.py - ç»Ÿä¸€APIå®¢æˆ·ç«¯å·¥å‚

**åŠŸèƒ½**: åˆ›å»ºå’Œç®¡ç†OpenAI/OpenRouterå®¢æˆ·ç«¯ã€‚

**æ ¸å¿ƒæ–¹æ³•**:
- `create_openrouter_client(api_key=None, base_url=None, timeout=300)`:
  - åˆ›å»ºOpenRouterå®¢æˆ·ç«¯
  - è‡ªåŠ¨ä»ç¯å¢ƒå˜é‡è¯»å–é…ç½®
  
- `create_openai_client(api_key=None, timeout=300)`:
  - åˆ›å»ºæ ‡å‡†OpenAIå®¢æˆ·ç«¯
  
- `get_model_name(model_type="default")`:
  - è·å–æ¨¡å‹åç§°
  - æ”¯æŒ: default, fast, powerful, gpt4

**è®¾è®¡ä¼˜åŠ¿**: ç»Ÿä¸€å®¢æˆ·ç«¯åˆå§‹åŒ–é€»è¾‘ï¼Œä¾¿äºåˆ‡æ¢APIæä¾›å•†å’Œæ¨¡å‹ã€‚

---

### 2. è·¯ç”±å±‚ (router/)

è·¯ç”±å±‚è´Ÿè´£æ¥æ”¶HTTPè¯·æ±‚ï¼Œè°ƒç”¨ä¸šåŠ¡é€»è¾‘ï¼Œç®¡ç†å¼‚æ­¥ä»»åŠ¡ã€‚

#### 2.1 main.py - ä¸»åº”ç”¨

**åŠŸèƒ½**: FastAPIä¸»åº”ç”¨ï¼Œé›†æˆä¸‰ä¸ªå­è·¯ç”±ã€‚

**æ ¸å¿ƒé…ç½®**:
- CORSä¸­é—´ä»¶ï¼šæ”¯æŒè·¨åŸŸè¯·æ±‚
- ä¸‰ä¸ªå­è·¯ç”±ï¼š
  - `/api/final-review/*` â†’ final_review_router
  - `/api/thesis-agent/*` â†’ thesis_agent_router  
  - `/api/web-agent/*` â†’ web_agent_router

**å¯åŠ¨æ–¹å¼**:
```bash
python router/start_server.py
# æˆ–
uvicorn router.main:app --host 0.0.0.0 --port 8000 --reload
```

#### 2.2 final_review_router.py - æ–‡æ¡£ä¼˜åŒ–è·¯ç”±

**åŠŸèƒ½**: æ£€æµ‹æ–‡æ¡£ä¸­çš„å†—ä½™å†…å®¹ï¼Œç”Ÿæˆä¼˜åŒ–å»ºè®®ã€‚

**æ ¸å¿ƒç«¯ç‚¹**:

1. `POST /api/final-review/v1/pipeline-async`
   - æäº¤æ–‡æ¡£ä¼˜åŒ–ä»»åŠ¡
   - å¼‚æ­¥å¤„ç†ï¼Œè¿”å›task_id
   
2. `GET /api/final-review/v1/task/{task_id}`
   - æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å’Œè¿›åº¦
   
3. `GET /api/final-review/v1/result/{task_id}`
   - è·å–ä¼˜åŒ–å»ºè®®ï¼ˆunified_sectionsæ ¼å¼ï¼‰
   
4. `GET /api/final-review/v1/optimized/{task_id}`
   - è·å–ä¼˜åŒ–åçš„å®Œæ•´Markdownæ–‡æ¡£

**å¤„ç†æµç¨‹**:
```
å®¢æˆ·ç«¯è¯·æ±‚ 
  â†’ åˆ›å»ºä»»åŠ¡ 
  â†’ åå°å¼‚æ­¥å¤„ç†
    â†’ æ­¥éª¤1: å…¨å±€æ–‡æ¡£åˆ†æ (document_reviewer)
    â†’ æ­¥éª¤2: ç”Ÿæˆä¿®æ”¹å»ºè®®
    â†’ æ­¥éª¤3: åº”ç”¨ä¿®æ”¹ (document_modifier)
  â†’ è¿”å›ç»“æœ
```

**ä½¿ç”¨çš„å…±äº«æ¨¡å—**:
- TaskManager: ä»»åŠ¡çŠ¶æ€ç®¡ç†
- DocumentParser: æ–‡æ¡£ç« èŠ‚è§£æ
- å¼‚å¸¸ç±»: LLMCallError, DocumentAnalysisError

#### 2.3 thesis_agent_router.py - è®ºç‚¹ä¸€è‡´æ€§è·¯ç”±

**åŠŸèƒ½**: æ£€æŸ¥æ–‡æ¡£ä¸­çš„è®ºç‚¹æ˜¯å¦ä¸€è‡´ï¼Œè‡ªåŠ¨ä¿®æ­£ä¸ä¸€è‡´çš„åœ°æ–¹ã€‚

**æ ¸å¿ƒç«¯ç‚¹**:

1. `POST /api/thesis-agent/v1/pipeline-async`
   - æäº¤è®ºç‚¹ä¸€è‡´æ€§æ£€æŸ¥ä»»åŠ¡
   - æ”¯æŒè‡ªåŠ¨ä¿®æ­£æ¨¡å¼
   
2. `GET /api/thesis-agent/v1/task/{task_id}`
   - æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
   
3. `GET /api/thesis-agent/v1/result/{task_id}`
   - è·å–æ£€æŸ¥ç»“æœï¼ˆunified_sectionsæ ¼å¼ï¼‰
   
4. `GET /api/thesis-agent/v1/optimized/{task_id}`
   - è·å–ä¿®æ­£åçš„Markdownæ–‡æ¡£

5. `GET /api/thesis-agent/v1/download/{task_id}`
   - ä¸‹è½½å¤„ç†ç»“æœ

**å¤„ç†æµç¨‹**:
```
å®¢æˆ·ç«¯è¯·æ±‚
  â†’ åˆ›å»ºä»»åŠ¡
  â†’ åå°å¼‚æ­¥å¤„ç†
    â†’ æ­¥éª¤1: æå–è®ºç‚¹ (thesis_extractor)
    â†’ æ­¥éª¤2: æ£€æŸ¥ä¸€è‡´æ€§ (thesis_consistency_checker)
    â†’ æ­¥éª¤3: é‡æ–°ç”Ÿæˆä¸ä¸€è‡´ç« èŠ‚ (document_regenerator)
    â†’ æ­¥éª¤4: åˆå¹¶æ–‡æ¡£ (json_merger)
  â†’ è¿”å›ç»“æœ
```

**ä½¿ç”¨çš„å…±äº«æ¨¡å—**:
- TaskManager: ä»»åŠ¡çŠ¶æ€ç®¡ç†
- DocumentParser: æ–‡æ¡£ç« èŠ‚è§£æ
- JSONDocumentMerger: æ–‡æ¡£åˆå¹¶
- å¼‚å¸¸ç±»: ThesisExtractionError, ConsistencyCheckError

#### 2.4 web_agent_router.py - è®ºæ®æ”¯æŒåº¦è·¯ç”±

**åŠŸèƒ½**: è¯†åˆ«æ–‡æ¡£ä¸­éœ€è¦è¯æ®æ”¯æŒçš„è®ºæ–­ï¼Œé€šè¿‡ç½‘ç»œæœç´¢æä¾›è¯æ®ã€‚

**æ ¸å¿ƒç«¯ç‚¹**:

1. `POST /api/web-agent/v1/pipeline-async`
   - æäº¤è®ºæ®æ”¯æŒåº¦è¯„ä¼°ä»»åŠ¡
   - æ”¯æŒç« èŠ‚å¹¶è¡Œå¤„ç†
   
2. `GET /api/web-agent/v1/task/{task_id}`
   - æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
   
3. `GET /api/web-agent/v1/result/{task_id}`
   - è·å–è¯æ®åˆ†æç»“æœJSON
   
4. `GET /api/web-agent/v1/enhanced/{task_id}`
   - è·å–å¢å¼ºåçš„Markdownæ–‡æ¡£

**å¤„ç†æµç¨‹**:
```
å®¢æˆ·ç«¯è¯·æ±‚
  â†’ åˆ›å»ºä»»åŠ¡
  â†’ åå°å¼‚æ­¥å¤„ç†
    â†’ æ­¥éª¤1: æå–æ–‡æ¡£ç« èŠ‚
    â†’ æ­¥éª¤2: å¹¶è¡Œå¤„ç†å„ç« èŠ‚
      â†’ æ£€æµ‹éœ€è¦è¯æ®çš„è®ºæ–­ (evidence_detector)
      â†’ ç½‘ç»œæœç´¢è¯æ® (web_search_agent)
      â†’ ç”Ÿæˆå¢å¼ºå†…å®¹
    â†’ æ­¥éª¤3: åˆå¹¶ç»“æœ
  â†’ è¿”å›ç»“æœ
```

**ä½¿ç”¨çš„å…±äº«æ¨¡å—**:
- TaskManager: ä»»åŠ¡çŠ¶æ€ç®¡ç†
- DocumentParser: æ–‡æ¡£ç« èŠ‚è§£æ
- å¼‚å¸¸ç±»: EvidenceSearchError, SectionGenerationError

---

### 3. ä¸šåŠ¡é€»è¾‘å±‚ (agent_app/)

æ¯ä¸ªagent_appåŒ…å«è¯¥æœåŠ¡çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œä¸è·¯ç”±å±‚è§£è€¦ã€‚

#### 3.1 final_review_agent_app/

**æ ¸å¿ƒæ–‡ä»¶**:
- `run_document_optimizer.py`: æ–‡æ¡£ä¼˜åŒ–å™¨ä¸»æµç¨‹
  - `DocumentOptimizer`: ä¼˜åŒ–å™¨ç±»
  - `step1_analyze_document()`: åˆ†ææ–‡æ¡£
  - `step2_modify_document()`: åº”ç”¨ä¿®æ”¹

- `document_reviewer.py`: æ–‡æ¡£å®¡æŸ¥å™¨
  - `analyze_document_global()`: å…¨å±€åˆ†æ
  - è¯†åˆ«å†—ä½™ã€é‡å¤ã€ä¸å¿…è¦çš„å†…å®¹

- `document_modifier.py`: æ–‡æ¡£ä¿®æ”¹å™¨
  - `modify_sections()`: æ‰¹é‡ä¿®æ”¹ç« èŠ‚
  - åº”ç”¨AIç”Ÿæˆçš„ä¿®æ”¹å»ºè®®

- `task_manager.py`: ä»»åŠ¡ç¼–æ’å™¨
  - ç®¡ç†å¤šæ­¥éª¤ä»»åŠ¡æµç¨‹
  - å¤„ç†ä»»åŠ¡ä¾èµ–å…³ç³»

#### 3.2 thesis_agent_app/

**æ ¸å¿ƒæ–‡ä»¶**:
- `run_thesis_checker.py`: è®ºç‚¹æ£€æŸ¥æµæ°´çº¿
  - `ThesisConsistencyPipeline`: æµæ°´çº¿ç±»
  - `run_full_pipeline()`: å®Œæ•´æµç¨‹

- `thesis_extractor.py`: è®ºç‚¹æå–å™¨
  - ä»æ–‡æ¡£ä¸­æå–æ ¸å¿ƒè®ºç‚¹
  - è¯†åˆ«è®ºç‚¹çš„å±‚æ¬¡å…³ç³»

- `thesis_consistency_checker.py`: ä¸€è‡´æ€§æ£€æŸ¥å™¨
  - æ£€æŸ¥è®ºç‚¹ä¹‹é—´çš„ä¸€è‡´æ€§
  - è¯†åˆ«çŸ›ç›¾å’Œä¸ä¸€è‡´

- `document_regenerator.py`: æ–‡æ¡£é‡ç”Ÿæˆå™¨
  - æ ¹æ®ä¸»è®ºç‚¹é‡æ–°ç”Ÿæˆä¸ä¸€è‡´çš„ç« èŠ‚
  - ä¿æŒè®ºç‚¹çš„ä¸€è‡´æ€§

#### 3.3 web_agent_app/

**æ ¸å¿ƒæ–‡ä»¶**:
- `whole_document_pipeline.py`: å®Œæ•´æ–‡æ¡£æµæ°´çº¿
  - `WholeDocumentPipeline`: æµæ°´çº¿ç±»
  - æ”¯æŒå¹¶è¡Œå’Œé¡ºåºå¤„ç†æ¨¡å¼

- `evidence_detector.py`: è¯æ®æ£€æµ‹å™¨
  - è¯†åˆ«éœ€è¦è¯æ®æ”¯æŒçš„è®ºæ–­
  - åˆ†ç±»è®ºæ–­ç±»å‹ï¼ˆäº‹å®æ€§ã€ç»Ÿè®¡æ€§ç­‰ï¼‰

- `web_search_agent.py`: ç½‘ç»œæœç´¢ä»£ç†
  - ä¸ºè®ºæ–­æœç´¢ç›¸å…³è¯æ®
  - è¯„ä¼°è¯æ®è´¨é‡

- `direct_document_merger.py`: æ–‡æ¡£åˆå¹¶å™¨
  - å°†è¯æ®å’ŒåŸæ–‡æ¡£åˆå¹¶
  - ç”Ÿæˆå¢å¼ºåçš„æ–‡æ¡£

---

## æ•°æ®æµè¯´æ˜

### ç»Ÿä¸€çš„ä»»åŠ¡å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚ (POST /v1/pipeline-async)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Routeråˆ›å»ºä»»åŠ¡                                        â”‚
â”‚     - task_id = create_task_id()                        â”‚
â”‚     - task_manager.create_task(task_id)                 â”‚
â”‚     - è¿”å›task_idç»™å®¢æˆ·ç«¯                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. åå°å¼‚æ­¥å¤„ç† (BackgroundTasks)                        â”‚
â”‚     - update_task_status(task_id, "processing", ...)    â”‚
â”‚     - è°ƒç”¨ä¸šåŠ¡é€»è¾‘å±‚å¤„ç†                                   â”‚
â”‚     - å¤„ç†è¿‡ç¨‹ä¸­æŒç»­æ›´æ–°è¿›åº¦                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. ä¸šåŠ¡é€»è¾‘å±‚å¤„ç†                                        â”‚
â”‚     - ä½¿ç”¨DocumentParserè§£ææ–‡æ¡£                          â”‚
â”‚     - è°ƒç”¨LLM APIï¼ˆé€šè¿‡APIClientFactoryï¼‰                 â”‚
â”‚     - å¦‚æœå¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼ˆä¸è¿”å›é»˜è®¤å€¼ï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. å¼‚å¸¸å¤„ç†                                              â”‚
â”‚     - ä¸šåŠ¡å±‚æŠ›å‡ºå¼‚å¸¸ (LLMCallErrorç­‰)                      â”‚
â”‚     - Routerå±‚æ•è·å¼‚å¸¸                                    â”‚
â”‚     - update_task_status(task_id, "failed", error=...)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. å®Œæˆä»»åŠ¡                                              â”‚
â”‚     - update_task_status(task_id, "completed", ...)     â”‚
â”‚     - å­˜å‚¨ç»“æœåˆ°task_manager                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. å®¢æˆ·ç«¯æŸ¥è¯¢ç»“æœ                                        â”‚
â”‚     - GET /v1/task/{task_id} â†’ æŸ¥çœ‹çŠ¶æ€                  â”‚
â”‚     - GET /v1/result/{task_id} â†’ è·å–ç»“æœ                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–‡æ¡£å¤„ç†çš„ç»Ÿä¸€æ ¼å¼

**è¾“å…¥æ ¼å¼** (Markdown):
```markdown
# ä¸€çº§æ ‡é¢˜
## äºŒçº§æ ‡é¢˜
### ä¸‰çº§æ ‡é¢˜
å†…å®¹...
```

**ä¸­é—´æ ¼å¼** (è§£æåçš„ç»“æ„):
```python
{
  "ä¸€çº§æ ‡é¢˜": {
    "äºŒçº§æ ‡é¢˜": "å†…å®¹...",
    "äºŒçº§æ ‡é¢˜ > ä¸‰çº§æ ‡é¢˜": "å†…å®¹..."
  }
}
```

**è¾“å‡ºæ ¼å¼** (unified_sections):
```json
{
  "ä¸€çº§æ ‡é¢˜": {
    "äºŒçº§æ ‡é¢˜": {
      "original_content": "åŸå§‹å†…å®¹",
      "suggestion": "ä¿®æ”¹å»ºè®®",
      "regenerated_content": "ä¿®æ”¹åå†…å®¹",
      "word_count": 1234,
      "status": "modified"
    }
  }
}
```

---

## é‡æ„æ”¹è¿›ç‚¹

### 1. æ¶ˆé™¤ä»£ç é‡å¤

**æ”¹è¿›å‰**:
- `json_merger.py` åœ¨2ä¸ªappä¸­é‡å¤ï¼ˆ401è¡Œå’Œ459è¡Œï¼‰
- æ–‡æ¡£è§£æå‡½æ•°åœ¨4ä¸ªåœ°æ–¹é‡å¤å®ç°
- ä»»åŠ¡ç®¡ç†ä»£ç åœ¨3ä¸ªrouterä¸­é‡å¤
- OpenAIå®¢æˆ·ç«¯åˆå§‹åŒ–åœ¨å¤šå¤„é‡å¤

**æ”¹è¿›å**:
- åˆ›å»º`shared/json_merger.py`ç»Ÿä¸€JSONåˆå¹¶é€»è¾‘
- åˆ›å»º`shared/document_parser.py`ç»Ÿä¸€æ–‡æ¡£è§£æ
- åˆ›å»º`shared/task_manager.py`ç»Ÿä¸€ä»»åŠ¡ç®¡ç†
- åˆ›å»º`shared/api_client_factory.py`ç»Ÿä¸€å®¢æˆ·ç«¯åˆ›å»º

**æ•ˆæœ**: ä»£ç é‡å¤å‡å°‘çº¦60%ï¼Œæ ¸å¿ƒé€»è¾‘é›†ä¸­ç®¡ç†ã€‚

### 2. åˆ é™¤Fallbackæœºåˆ¶

**æ”¹è¿›å‰**:
```python
# é”™è¯¯ç¤ºä¾‹ï¼šå¤±è´¥æ—¶è¿”å›åŸå†…å®¹
try:
    result = call_llm()
    return result
except Exception:
    return original_content  # âŒ é™é»˜å¤±è´¥
```

**æ”¹è¿›å**:
```python
# æ­£ç¡®ç¤ºä¾‹ï¼šå¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸
try:
    result = call_llm()
    return result
except Exception as e:
    raise LLMCallError(f"LLMè°ƒç”¨å¤±è´¥: {e}")  # âœ… æ˜ç¡®æŠ¥é”™
```

**åˆ é™¤çš„Fallback**:
- `final_review_router.py`: é»˜è®¤å»ºè®®ç”Ÿæˆæœºåˆ¶ï¼ˆ107-140è¡Œï¼‰
- `run_document_optimizer.py`: LLMå¤±è´¥è¿”å›åŸå†…å®¹
- `document_reviewer.py`: åˆ†æå¤±è´¥è¿”å›ç©ºç»“æœ

**æ•ˆæœ**: æ‰€æœ‰é”™è¯¯éƒ½æ˜ç¡®æŠ¥å‘Šï¼Œä¸ä¼šæœ‰éšè—çš„å¤±è´¥ã€‚

### 3. ç»Ÿä¸€æ–‡æ¡£è§£æ

**æ”¹è¿›å‰**: 4å¤„ä¸åŒå®ç°ï¼Œé€»è¾‘ç•¥æœ‰å·®å¼‚
- `thesis_agent_router.py`: parse_hierarchical_sections
- `web_agent_router.py`: extract_document_sections
- `run_document_optimizer.py`: _parse_document_sections
- `whole_document_pipeline.py`: _extract_sections_from_content

**æ”¹è¿›å**: ç»Ÿä¸€ä½¿ç”¨`DocumentParser.parse_sections()`
- æ”¯æŒ1-3çº§æ ‡é¢˜
- ç»Ÿä¸€çš„`section_key`æ ¼å¼: `"h2"` æˆ– `"h2 > h3"`
- æ”¯æŒä¿æŒç« èŠ‚é¡ºåº
- æ‰€æœ‰æ¨¡å—ä½¿ç”¨ç›¸åŒé€»è¾‘

**æ•ˆæœ**: æ¶ˆé™¤è§£æä¸ä¸€è‡´ï¼Œç»´æŠ¤æ›´ç®€å•ã€‚

### 4. ç»Ÿä¸€ä»»åŠ¡ç®¡ç†

**æ”¹è¿›å‰**: æ¯ä¸ªrouterè‡ªå·±çš„task_storageå­—å…¸

**æ”¹è¿›å**: ç»Ÿä¸€çš„TaskManagerç±»
- æ ‡å‡†åŒ–çš„ä»»åŠ¡çŠ¶æ€å®šä¹‰
- ç»Ÿä¸€çš„æ›´æ–°æ–¹æ³•
- è‡ªåŠ¨è®°å½•æ—¶é—´æˆ³
- æ”¯æŒä»»åŠ¡æ¸…ç†

**æ•ˆæœ**: ä»»åŠ¡ç®¡ç†é€»è¾‘ä¸€è‡´ï¼ŒçŠ¶æ€è¿½è¸ªæ›´å¯é ã€‚

### 5. ç»Ÿä¸€å¼‚å¸¸å¤„ç†

**æ”¹è¿›å‰**: è¿”å›é”™è¯¯å­—å…¸æˆ–None

**æ”¹è¿›å**: æŠ›å‡ºæ˜ç¡®çš„å¼‚å¸¸ç±»å‹
- ä¸šåŠ¡å±‚æŠ›å‡ºå…·ä½“å¼‚å¸¸
- è·¯ç”±å±‚ç»Ÿä¸€æ•è·
- å®¢æˆ·ç«¯æ”¶åˆ°æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯

**æ•ˆæœ**: é”™è¯¯å¤„ç†æ›´æ¸…æ™°ï¼Œè°ƒè¯•æ›´å®¹æ˜“ã€‚

---

## ä½¿ç”¨æŒ‡å—

### å¯åŠ¨æœåŠ¡

```bash
# æ–¹å¼1: ä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰
cd router
python start_server.py
# æœåŠ¡å°†åœ¨ http://localhost:8010 å¯åŠ¨

# æ–¹å¼2: ç›´æ¥ä½¿ç”¨uvicorn
uvicorn router.main:app --host 0.0.0.0 --port 8010 --reload
```

### ç¯å¢ƒå˜é‡é…ç½®

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º`.env`æ–‡ä»¶ï¼š

```bash
# OpenRouter APIé…ç½®
OPENROUTER_API_KEY=your_api_key_here
OPENROUTER_BASE_URL=https://openrouter.ai/api/v1

# æ¨¡å‹é…ç½®
DEFAULT_MODEL=anthropic/claude-3.5-sonnet
FAST_MODEL=anthropic/claude-3-haiku
POWERFUL_MODEL=anthropic/claude-3-opus

# æ—¥å¿—é…ç½®
LOG_LEVEL=INFO

# å¹¶è¡Œå¤„ç†é…ç½®
MAX_WORKERS=5
ENABLE_PARALLEL_SEARCH=true
ENABLE_PARALLEL_ENHANCEMENT=true
```

### APIä½¿ç”¨ç¤ºä¾‹

#### 1. æ–‡æ¡£ä¼˜åŒ–æœåŠ¡

```python
import requests

# æäº¤ä»»åŠ¡
response = requests.post(
    "http://localhost:8010/api/final-review/v1/pipeline-async",
    json={
        "document_content": "# æ ‡é¢˜\n## ç« èŠ‚\nå†…å®¹...",
        "document_title": "æˆ‘çš„æ–‡æ¡£",
        "filename": "document.md"
    }
)
task_id = response.json()["task_id"]

# æŸ¥è¯¢çŠ¶æ€
status = requests.get(
    f"http://localhost:8010/api/final-review/v1/task/{task_id}"
)
print(status.json())

# è·å–ç»“æœ
result = requests.get(
    f"http://localhost:8010/api/final-review/v1/result/{task_id}"
)
print(result.json())
```

#### 2. è®ºç‚¹ä¸€è‡´æ€§æ£€æŸ¥

```python
# æäº¤ä»»åŠ¡
response = requests.post(
    "http://localhost:8010/api/thesis-agent/v1/pipeline-async",
    json={
        "document_content": "æ–‡æ¡£å†…å®¹...",
        "document_title": "æˆ‘çš„æ–‡æ¡£",
        "auto_correct": True  # è‡ªåŠ¨ä¿®æ­£
    }
)
task_id = response.json()["task_id"]

# è·å–ä¿®æ­£åçš„æ–‡æ¡£
corrected_doc = requests.get(
    f"http://localhost:8010/api/thesis-agent/v1/optimized/{task_id}"
)
```

#### 3. è®ºæ®æ”¯æŒåº¦è¯„ä¼°

```python
# æäº¤ä»»åŠ¡
response = requests.post(
    "http://localhost:8010/api/web-agent/v1/pipeline-async",
    json={
        "document_content": "æ–‡æ¡£å†…å®¹...",
        "document_title": "æˆ‘çš„æ–‡æ¡£"
    }
)
task_id = response.json()["task_id"]

# è·å–å¢å¼ºåçš„æ–‡æ¡£
enhanced_doc = requests.get(
    f"http://localhost:8010/api/web-agent/v1/enhanced/{task_id}"
)
```

### å¼€å‘æŒ‡å—

#### æ·»åŠ æ–°åŠŸèƒ½

1. **å¦‚æœéœ€è¦æ–°çš„å…±äº«åŠŸèƒ½**ï¼š
   - åœ¨`shared/`ç›®å½•ä¸‹åˆ›å»ºæ–°æ¨¡å—
   - åœ¨`shared/__init__.py`ä¸­å¯¼å‡º
   - åœ¨routerä¸­å¯¼å…¥ä½¿ç”¨

2. **å¦‚æœéœ€è¦æ–°çš„è·¯ç”±**ï¼š
   - åœ¨`router/routers/`ä¸‹åˆ›å»ºæ–°routeræ–‡ä»¶
   - ä½¿ç”¨`shared`æ¨¡å—ä¸­çš„TaskManagerå’ŒDocumentParser
   - åœ¨`router/main.py`ä¸­æ³¨å†Œè·¯ç”±

3. **å¦‚æœéœ€è¦ä¿®æ”¹ä¸šåŠ¡é€»è¾‘**ï¼š
   - ä¿®æ”¹å¯¹åº”çš„`agent_app/`ç›®å½•
   - ç¡®ä¿æŠ›å‡ºé€‚å½“çš„å¼‚å¸¸è€Œä¸æ˜¯è¿”å›é”™è¯¯å€¼
   - æ›´æ–°ç›¸å…³çš„routerå¤„ç†é€»è¾‘

#### ä»£ç è§„èŒƒ

1. **å¼‚å¸¸å¤„ç†**:
   ```python
   # âœ… æ­£ç¡®
   from shared import LLMCallError
   
   try:
       result = some_operation()
   except Exception as e:
       raise LLMCallError(f"æ“ä½œå¤±è´¥: {e}")
   
   # âŒ é”™è¯¯
   try:
       result = some_operation()
   except Exception:
       return default_value
   ```

2. **æ–‡æ¡£è§£æ**:
   ```python
   # âœ… æ­£ç¡®
   from shared import DocumentParser
   
   sections = DocumentParser.parse_sections(content, max_level=3)
   
   # âŒ é”™è¯¯ - ä¸è¦è‡ªå·±å®ç°è§£æé€»è¾‘
   sections = custom_parse_function(content)
   ```

3. **ä»»åŠ¡ç®¡ç†**:
   ```python
   # âœ… æ­£ç¡®
   from shared import TaskManager
   
   task_manager = TaskManager()
   task_manager.create_task(task_id)
   task_manager.update_task(task_id, status="processing", progress=0.5)
   
   # âŒ é”™è¯¯ - ä¸è¦ä½¿ç”¨è‡ªå·±çš„å­—å…¸
   task_storage[task_id] = {...}
   ```

### æµ‹è¯•

```bash
# è¿è¡Œlinteræ£€æŸ¥
python -m pylint shared/ router/ --disable=all --enable=E,F

# æµ‹è¯•å•ä¸ªæœåŠ¡
python -m pytest tests/test_document_optimizer.py
python -m pytest tests/test_thesis_checker.py
python -m pytest tests/test_evidence_support.py
```

---

## æ€»ç»“

### é‡æ„æˆæœ

âœ… **ä»£ç ç»Ÿä¸€**: æ¶ˆé™¤é‡å¤ä»£ç 60%ï¼Œæ ¸å¿ƒé€»è¾‘é›†ä¸­åœ¨sharedæ¨¡å—  
âœ… **é”™è¯¯å¤„ç†**: åˆ é™¤æ‰€æœ‰fallbackæœºåˆ¶ï¼Œä½¿ç”¨å¼‚å¸¸æ˜ç¡®æŠ¥é”™  
âœ… **æ–‡æ¡£è§£æ**: ç»Ÿä¸€çš„3çº§æ ‡é¢˜è§£æé€»è¾‘  
âœ… **ä»»åŠ¡ç®¡ç†**: ç»Ÿä¸€çš„å¼‚æ­¥ä»»åŠ¡çŠ¶æ€è¿½è¸ª  
âœ… **æ˜“äºç»´æŠ¤**: æ–°åŠŸèƒ½å¼€å‘æ›´å¿«ï¼Œbugä¿®å¤æ›´å®¹æ˜“  

### æ¶æ„ä¼˜åŠ¿

1. **æ¨¡å—åŒ–**: å…±äº«æ¨¡å—ã€è·¯ç”±å±‚ã€ä¸šåŠ¡é€»è¾‘å±‚æ¸…æ™°åˆ†ç¦»
2. **å¯æ‰©å±•**: æ·»åŠ æ–°æœåŠ¡åªéœ€åˆ›å»ºæ–°routerå’Œapp
3. **å¯æµ‹è¯•**: æ¯ä¸ªæ¨¡å—éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•
4. **å¯ç»´æŠ¤**: ä¿®æ”¹ä¸€å¤„ï¼Œæ‰€æœ‰åœ°æ–¹ç”Ÿæ•ˆ
5. **å¯é æ€§**: æ˜ç¡®çš„é”™è¯¯å¤„ç†ï¼Œä¸ä¼šé™é»˜å¤±è´¥

### ä¸‹ä¸€æ­¥å»ºè®®

1. æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–å…±äº«æ¨¡å—
2. æ·»åŠ APIé›†æˆæµ‹è¯•
3. å®ç°ä»»åŠ¡ç»“æœçš„æŒä¹…åŒ–å­˜å‚¨
4. æ·»åŠ æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—èšåˆ
5. å®ç°è¯·æ±‚é™æµå’Œè´Ÿè½½å‡è¡¡

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-08  
**ç»´æŠ¤è€…**: AI Code Refactoring Team

