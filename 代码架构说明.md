# 代码架构说明文档

生成时间: 2025-10-08

## 📋 目录

1. [系统概述](#系统概述)
2. [整体架构](#整体架构)
3. [核心模块说明](#核心模块说明)
4. [数据流说明](#数据流说明)
5. [重构改进点](#重构改进点)
6. [使用指南](#使用指南)

---

## 系统概述

本系统是一个基于FastAPI的文档智能处理平台，集成了三个核心AI服务：

1. **文档优化服务** (Final Review Agent) - 检测并优化文档中的冗余内容
2. **论点一致性检查服务** (Thesis Agent) - 确保文档论点的一致性
3. **论据支持度评估服务** (Web Agent) - 通过网络搜索为论断提供证据支持

系统采用**统一路由 + 独立业务模块**的架构，所有服务通过统一的API网关对外提供服务。

---

## 整体架构

### 目录结构

```
review_agent_save/
│
├── shared/                              # 【新增】共享模块
│   ├── __init__.py                      # 模块导出
│   ├── exceptions.py                    # 统一异常定义
│   ├── task_manager.py                  # 统一任务管理
│   ├── document_parser.py               # 统一文档解析
│   ├── json_merger.py                   # 统一JSON合并器
│   └── api_client_factory.py            # 统一API客户端工厂
│
├── router/                              # 统一路由层
│   ├── main.py                          # FastAPI主应用
│   ├── config.py                        # 统一配置管理
│   ├── start_server.py                  # 服务启动脚本
│   └── routers/                         # 路由模块
│       ├── final_review_router.py       # 文档优化路由
│       ├── thesis_agent_router.py       # 论点一致性路由
│       └── web_agent_router.py          # 论据支持度路由
│
├── final_review_agent_app/              # 文档优化业务逻辑
│   ├── run_document_optimizer.py        # 文档优化器
│   ├── document_reviewer.py             # 文档审查器
│   ├── document_modifier.py             # 文档修改器
│   ├── task_manager.py                  # 任务编排器
│   └── models.py                        # 数据模型
│
├── thesis_agent_app/                    # 论点一致性业务逻辑
│   ├── run_thesis_checker.py            # 论点检查流水线
│   ├── thesis_extractor.py              # 论点提取器
│   ├── thesis_consistency_checker.py    # 一致性检查器
│   └── document_regenerator.py          # 文档重生成器
│
└── web_agent_app/                       # 论据支持度业务逻辑
    ├── whole_document_pipeline.py       # 完整文档流水线
    ├── evidence_detector.py             # 证据检测器
    ├── web_search_agent.py              # 网络搜索代理
    └── direct_document_merger.py        # 文档合并器
```

### 架构层次

```
┌─────────────────────────────────────────────────────────┐
│                    客户端 (HTTP/JSON)                      │
└─────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────┐
│              统一路由层 (router/main.py)                   │
│  ┌──────────────┬──────────────┬──────────────┐         │
│  │ Final Review │ Thesis Agent │  Web Agent   │         │
│  │   Router     │    Router    │   Router     │         │
│  └──────────────┴──────────────┴──────────────┘         │
└─────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────┐
│                   共享模块 (shared/)                       │
│  ┌────────────┬────────────┬────────────┬─────────────┐ │
│  │ Task       │ Document   │ JSON       │ API Client  │ │
│  │ Manager    │ Parser     │ Merger     │ Factory     │ │
│  └────────────┴────────────┴────────────┴─────────────┘ │
│  ┌──────────────────────────────────────────────────┐   │
│  │            Exceptions (统一异常处理)               │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────┐
│                  业务逻辑层 (agent_app/)                   │
│  ┌──────────────┬──────────────┬──────────────┐         │
│  │ Final Review │ Thesis Agent │  Web Agent   │         │
│  │     App      │     App      │     App      │         │
│  └──────────────┴──────────────┴──────────────┘         │
└─────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────┐
│              外部服务 (OpenRouter AI API)                  │
└─────────────────────────────────────────────────────────┘
```

---

## 核心模块说明

### 1. 共享模块 (shared/)

共享模块是本次重构的核心成果，提取了所有三个服务的公共代码，避免重复。

#### 1.1 exceptions.py - 统一异常定义

**功能**: 定义所有业务异常，替代fallback机制。

**核心异常类**:
```python
AgentBaseException          # 基础异常类
├── LLMCallError           # LLM API调用失败
├── DocumentAnalysisError  # 文档分析失败
├── DocumentParseError     # 文档解析失败
├── EvidenceSearchError    # 证据搜索失败
├── SectionGenerationError # 章节生成失败
├── ThesisExtractionError  # 论点提取失败
└── ConsistencyCheckError  # 一致性检查失败
```

**设计原则**: 
- 所有错误都通过异常明确报告，不返回默认值
- 异常在路由层统一捕获和处理
- 为不同类型的错误提供明确的异常类型

#### 1.2 task_manager.py - 统一任务管理

**功能**: 管理所有异步任务的状态跟踪。

**核心类**:
- `TaskManager`: 任务管理器
  - `create_task(task_id)`: 创建新任务
  - `update_task(task_id, **kwargs)`: 更新任务状态
  - `get_task(task_id)`: 获取任务详情
  - `get_task_status(task_id)`: 获取任务状态（返回Pydantic模型）
  - `task_exists(task_id)`: 检查任务是否存在
  - `delete_task(task_id)`: 删除任务
  - `clear_old_tasks(max_age_seconds)`: 清理过期任务

- `TaskStatus`: 任务状态模型
  - `task_id`: 任务ID
  - `status`: 状态 (pending/processing/completed/failed)
  - `progress`: 进度 (0.0-1.0)
  - `message`: 状态消息
  - `result`: 任务结果
  - `error`: 错误信息
  - `start_time/end_time`: 时间戳

**使用场景**: 三个router都使用同一个TaskManager实例，确保任务状态管理的一致性。

#### 1.3 document_parser.py - 统一文档解析

**功能**: 解析Markdown文档的标题结构，支持1-3级标题嵌套。

**核心方法**:
- `parse_sections(content, max_level=3, preserve_order=True)`: 
  - 解析文档为嵌套结构: `{h1: {section_key: content}}`
  - `section_key` 格式: `"h2"` 或 `"h2 > h3"`
  - 支持保持章节顺序

- `parse_flat_sections(content, level=1)`: 
  - 扁平化解析，按指定级别分割
  - 返回: `{section_title: section_content}`

- `extract_section_content(full_content, section_title, fuzzy_match=True)`:
  - 从完整文档中提取指定章节
  - 支持模糊匹配

**标题结构示例**:
```
# H1标题                  ← 一级标题
## H2标题                ← 二级标题
### H3标题              ← 三级标题
内容...

解析结果:
{
  "H1标题": {
    "H2标题 > H3标题": "内容..."
  }
}
```

#### 1.4 json_merger.py - 统一JSON合并器

**功能**: 在JSON层面进行文档章节替换，然后转换为Markdown。

**核心类**:
- `JSONDocumentMerger`: JSON文档合并器
  - `load_original_json()`: 加载原始JSON
  - `load_regenerated_sections()`: 加载重新生成的章节
  - `find_section_in_json(section_title)`: 在JSON中查找章节
  - `merge_json_documents()`: 合并文档
  - `save_merged_json(merged_data, output_path)`: 保存结果
  - `convert_to_markdown(merged_data, output_path)`: 转换为Markdown

- `SimpleMarkdownConverter`: Markdown转换器
  - `convert_to_markdown(json_data)`: JSON转Markdown

**核心函数**:
- `update_json_sections_inplace(target_json_path, regenerated_json_path, correction_type)`:
  - 直接更新JSON文件中的章节内容
  - 保留原有的图片、表格等元数据
  - 只更新`generated_content`字段

**使用场景**: Thesis Agent和Final Review Agent都需要合并文档，使用统一的合并逻辑。

#### 1.5 api_client_factory.py - 统一API客户端工厂

**功能**: 创建和管理OpenAI/OpenRouter客户端。

**核心方法**:
- `create_openrouter_client(api_key=None, base_url=None, timeout=300)`:
  - 创建OpenRouter客户端
  - 自动从环境变量读取配置
  
- `create_openai_client(api_key=None, timeout=300)`:
  - 创建标准OpenAI客户端
  
- `get_model_name(model_type="default")`:
  - 获取模型名称
  - 支持: default, fast, powerful, gpt4

**设计优势**: 统一客户端初始化逻辑，便于切换API提供商和模型。

---

### 2. 路由层 (router/)

路由层负责接收HTTP请求，调用业务逻辑，管理异步任务。

#### 2.1 main.py - 主应用

**功能**: FastAPI主应用，集成三个子路由。

**核心配置**:
- CORS中间件：支持跨域请求
- 三个子路由：
  - `/api/final-review/*` → final_review_router
  - `/api/thesis-agent/*` → thesis_agent_router  
  - `/api/web-agent/*` → web_agent_router

**启动方式**:
```bash
python router/start_server.py
# 或
uvicorn router.main:app --host 0.0.0.0 --port 8000 --reload
```

#### 2.2 final_review_router.py - 文档优化路由

**功能**: 检测文档中的冗余内容，生成优化建议。

**核心端点**:

1. `POST /api/final-review/v1/pipeline-async`
   - 提交文档优化任务
   - 异步处理，返回task_id
   
2. `GET /api/final-review/v1/task/{task_id}`
   - 查询任务状态和进度
   
3. `GET /api/final-review/v1/result/{task_id}`
   - 获取优化建议（unified_sections格式）
   
4. `GET /api/final-review/v1/optimized/{task_id}`
   - 获取优化后的完整Markdown文档

**处理流程**:
```
客户端请求 
  → 创建任务 
  → 后台异步处理
    → 步骤1: 全局文档分析 (document_reviewer)
    → 步骤2: 生成修改建议
    → 步骤3: 应用修改 (document_modifier)
  → 返回结果
```

**使用的共享模块**:
- TaskManager: 任务状态管理
- DocumentParser: 文档章节解析
- 异常类: LLMCallError, DocumentAnalysisError

#### 2.3 thesis_agent_router.py - 论点一致性路由

**功能**: 检查文档中的论点是否一致，自动修正不一致的地方。

**核心端点**:

1. `POST /api/thesis-agent/v1/pipeline-async`
   - 提交论点一致性检查任务
   - 支持自动修正模式
   
2. `GET /api/thesis-agent/v1/task/{task_id}`
   - 查询任务状态
   
3. `GET /api/thesis-agent/v1/result/{task_id}`
   - 获取检查结果（unified_sections格式）
   
4. `GET /api/thesis-agent/v1/optimized/{task_id}`
   - 获取修正后的Markdown文档

5. `GET /api/thesis-agent/v1/download/{task_id}`
   - 下载处理结果

**处理流程**:
```
客户端请求
  → 创建任务
  → 后台异步处理
    → 步骤1: 提取论点 (thesis_extractor)
    → 步骤2: 检查一致性 (thesis_consistency_checker)
    → 步骤3: 重新生成不一致章节 (document_regenerator)
    → 步骤4: 合并文档 (json_merger)
  → 返回结果
```

**使用的共享模块**:
- TaskManager: 任务状态管理
- DocumentParser: 文档章节解析
- JSONDocumentMerger: 文档合并
- 异常类: ThesisExtractionError, ConsistencyCheckError

#### 2.4 web_agent_router.py - 论据支持度路由

**功能**: 识别文档中需要证据支持的论断，通过网络搜索提供证据。

**核心端点**:

1. `POST /api/web-agent/v1/pipeline-async`
   - 提交论据支持度评估任务
   - 支持章节并行处理
   
2. `GET /api/web-agent/v1/task/{task_id}`
   - 查询任务状态
   
3. `GET /api/web-agent/v1/result/{task_id}`
   - 获取证据分析结果JSON
   
4. `GET /api/web-agent/v1/enhanced/{task_id}`
   - 获取增强后的Markdown文档

**处理流程**:
```
客户端请求
  → 创建任务
  → 后台异步处理
    → 步骤1: 提取文档章节
    → 步骤2: 并行处理各章节
      → 检测需要证据的论断 (evidence_detector)
      → 网络搜索证据 (web_search_agent)
      → 生成增强内容
    → 步骤3: 合并结果
  → 返回结果
```

**使用的共享模块**:
- TaskManager: 任务状态管理
- DocumentParser: 文档章节解析
- 异常类: EvidenceSearchError, SectionGenerationError

---

### 3. 业务逻辑层 (agent_app/)

每个agent_app包含该服务的核心业务逻辑，与路由层解耦。

#### 3.1 final_review_agent_app/

**核心文件**:
- `run_document_optimizer.py`: 文档优化器主流程
  - `DocumentOptimizer`: 优化器类
  - `step1_analyze_document()`: 分析文档
  - `step2_modify_document()`: 应用修改

- `document_reviewer.py`: 文档审查器
  - `analyze_document_global()`: 全局分析
  - 识别冗余、重复、不必要的内容

- `document_modifier.py`: 文档修改器
  - `modify_sections()`: 批量修改章节
  - 应用AI生成的修改建议

- `task_manager.py`: 任务编排器
  - 管理多步骤任务流程
  - 处理任务依赖关系

#### 3.2 thesis_agent_app/

**核心文件**:
- `run_thesis_checker.py`: 论点检查流水线
  - `ThesisConsistencyPipeline`: 流水线类
  - `run_full_pipeline()`: 完整流程

- `thesis_extractor.py`: 论点提取器
  - 从文档中提取核心论点
  - 识别论点的层次关系

- `thesis_consistency_checker.py`: 一致性检查器
  - 检查论点之间的一致性
  - 识别矛盾和不一致

- `document_regenerator.py`: 文档重生成器
  - 根据主论点重新生成不一致的章节
  - 保持论点的一致性

#### 3.3 web_agent_app/

**核心文件**:
- `whole_document_pipeline.py`: 完整文档流水线
  - `WholeDocumentPipeline`: 流水线类
  - 支持并行和顺序处理模式

- `evidence_detector.py`: 证据检测器
  - 识别需要证据支持的论断
  - 分类论断类型（事实性、统计性等）

- `web_search_agent.py`: 网络搜索代理
  - 为论断搜索相关证据
  - 评估证据质量

- `direct_document_merger.py`: 文档合并器
  - 将证据和原文档合并
  - 生成增强后的文档

---

## 数据流说明

### 统一的任务处理流程

```
┌─────────────────────────────────────────────────────────┐
│  1. 客户端发送请求 (POST /v1/pipeline-async)              │
└─────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────┐
│  2. Router创建任务                                        │
│     - task_id = create_task_id()                        │
│     - task_manager.create_task(task_id)                 │
│     - 返回task_id给客户端                                 │
└─────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────┐
│  3. 后台异步处理 (BackgroundTasks)                        │
│     - update_task_status(task_id, "processing", ...)    │
│     - 调用业务逻辑层处理                                   │
│     - 处理过程中持续更新进度                               │
└─────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────┐
│  4. 业务逻辑层处理                                        │
│     - 使用DocumentParser解析文档                          │
│     - 调用LLM API（通过APIClientFactory）                 │
│     - 如果失败，抛出异常（不返回默认值）                     │
└─────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────┐
│  5. 异常处理                                              │
│     - 业务层抛出异常 (LLMCallError等)                      │
│     - Router层捕获异常                                    │
│     - update_task_status(task_id, "failed", error=...)  │
└─────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────┐
│  6. 完成任务                                              │
│     - update_task_status(task_id, "completed", ...)     │
│     - 存储结果到task_manager                              │
└─────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────┐
│  7. 客户端查询结果                                        │
│     - GET /v1/task/{task_id} → 查看状态                  │
│     - GET /v1/result/{task_id} → 获取结果                │
└─────────────────────────────────────────────────────────┘
```

### 文档处理的统一格式

**输入格式** (Markdown):
```markdown
# 一级标题
## 二级标题
### 三级标题
内容...
```

**中间格式** (解析后的结构):
```python
{
  "一级标题": {
    "二级标题": "内容...",
    "二级标题 > 三级标题": "内容..."
  }
}
```

**输出格式** (unified_sections):
```json
{
  "一级标题": {
    "二级标题": {
      "original_content": "原始内容",
      "suggestion": "修改建议",
      "regenerated_content": "修改后内容",
      "word_count": 1234,
      "status": "modified"
    }
  }
}
```

---

## 重构改进点

### 1. 消除代码重复

**改进前**:
- `json_merger.py` 在2个app中重复（401行和459行）
- 文档解析函数在4个地方重复实现
- 任务管理代码在3个router中重复
- OpenAI客户端初始化在多处重复

**改进后**:
- 创建`shared/json_merger.py`统一JSON合并逻辑
- 创建`shared/document_parser.py`统一文档解析
- 创建`shared/task_manager.py`统一任务管理
- 创建`shared/api_client_factory.py`统一客户端创建

**效果**: 代码重复减少约60%，核心逻辑集中管理。

### 2. 删除Fallback机制

**改进前**:
```python
# 错误示例：失败时返回原内容
try:
    result = call_llm()
    return result
except Exception:
    return original_content  # ❌ 静默失败
```

**改进后**:
```python
# 正确示例：失败时抛出异常
try:
    result = call_llm()
    return result
except Exception as e:
    raise LLMCallError(f"LLM调用失败: {e}")  # ✅ 明确报错
```

**删除的Fallback**:
- `final_review_router.py`: 默认建议生成机制（107-140行）
- `run_document_optimizer.py`: LLM失败返回原内容
- `document_reviewer.py`: 分析失败返回空结果

**效果**: 所有错误都明确报告，不会有隐藏的失败。

### 3. 统一文档解析

**改进前**: 4处不同实现，逻辑略有差异
- `thesis_agent_router.py`: parse_hierarchical_sections
- `web_agent_router.py`: extract_document_sections
- `run_document_optimizer.py`: _parse_document_sections
- `whole_document_pipeline.py`: _extract_sections_from_content

**改进后**: 统一使用`DocumentParser.parse_sections()`
- 支持1-3级标题
- 统一的`section_key`格式: `"h2"` 或 `"h2 > h3"`
- 支持保持章节顺序
- 所有模块使用相同逻辑

**效果**: 消除解析不一致，维护更简单。

### 4. 统一任务管理

**改进前**: 每个router自己的task_storage字典

**改进后**: 统一的TaskManager类
- 标准化的任务状态定义
- 统一的更新方法
- 自动记录时间戳
- 支持任务清理

**效果**: 任务管理逻辑一致，状态追踪更可靠。

### 5. 统一异常处理

**改进前**: 返回错误字典或None

**改进后**: 抛出明确的异常类型
- 业务层抛出具体异常
- 路由层统一捕获
- 客户端收到明确的错误信息

**效果**: 错误处理更清晰，调试更容易。

---

## 使用指南

### 启动服务

```bash
# 方式1: 使用启动脚本（推荐）
cd router
python start_server.py
# 服务将在 http://localhost:8010 启动

# 方式2: 直接使用uvicorn
uvicorn router.main:app --host 0.0.0.0 --port 8010 --reload
```

### 环境变量配置

在项目根目录创建`.env`文件：

```bash
# OpenRouter API配置
OPENROUTER_API_KEY=your_api_key_here
OPENROUTER_BASE_URL=https://openrouter.ai/api/v1

# 模型配置
DEFAULT_MODEL=anthropic/claude-3.5-sonnet
FAST_MODEL=anthropic/claude-3-haiku
POWERFUL_MODEL=anthropic/claude-3-opus

# 日志配置
LOG_LEVEL=INFO

# 并行处理配置
MAX_WORKERS=5
ENABLE_PARALLEL_SEARCH=true
ENABLE_PARALLEL_ENHANCEMENT=true
```

### API使用示例

#### 1. 文档优化服务

```python
import requests

# 提交任务
response = requests.post(
    "http://localhost:8010/api/final-review/v1/pipeline-async",
    json={
        "document_content": "# 标题\n## 章节\n内容...",
        "document_title": "我的文档",
        "filename": "document.md"
    }
)
task_id = response.json()["task_id"]

# 查询状态
status = requests.get(
    f"http://localhost:8010/api/final-review/v1/task/{task_id}"
)
print(status.json())

# 获取结果
result = requests.get(
    f"http://localhost:8010/api/final-review/v1/result/{task_id}"
)
print(result.json())
```

#### 2. 论点一致性检查

```python
# 提交任务
response = requests.post(
    "http://localhost:8010/api/thesis-agent/v1/pipeline-async",
    json={
        "document_content": "文档内容...",
        "document_title": "我的文档",
        "auto_correct": True  # 自动修正
    }
)
task_id = response.json()["task_id"]

# 获取修正后的文档
corrected_doc = requests.get(
    f"http://localhost:8010/api/thesis-agent/v1/optimized/{task_id}"
)
```

#### 3. 论据支持度评估

```python
# 提交任务
response = requests.post(
    "http://localhost:8010/api/web-agent/v1/pipeline-async",
    json={
        "document_content": "文档内容...",
        "document_title": "我的文档"
    }
)
task_id = response.json()["task_id"]

# 获取增强后的文档
enhanced_doc = requests.get(
    f"http://localhost:8010/api/web-agent/v1/enhanced/{task_id}"
)
```

### 开发指南

#### 添加新功能

1. **如果需要新的共享功能**：
   - 在`shared/`目录下创建新模块
   - 在`shared/__init__.py`中导出
   - 在router中导入使用

2. **如果需要新的路由**：
   - 在`router/routers/`下创建新router文件
   - 使用`shared`模块中的TaskManager和DocumentParser
   - 在`router/main.py`中注册路由

3. **如果需要修改业务逻辑**：
   - 修改对应的`agent_app/`目录
   - 确保抛出适当的异常而不是返回错误值
   - 更新相关的router处理逻辑

#### 代码规范

1. **异常处理**:
   ```python
   # ✅ 正确
   from shared import LLMCallError
   
   try:
       result = some_operation()
   except Exception as e:
       raise LLMCallError(f"操作失败: {e}")
   
   # ❌ 错误
   try:
       result = some_operation()
   except Exception:
       return default_value
   ```

2. **文档解析**:
   ```python
   # ✅ 正确
   from shared import DocumentParser
   
   sections = DocumentParser.parse_sections(content, max_level=3)
   
   # ❌ 错误 - 不要自己实现解析逻辑
   sections = custom_parse_function(content)
   ```

3. **任务管理**:
   ```python
   # ✅ 正确
   from shared import TaskManager
   
   task_manager = TaskManager()
   task_manager.create_task(task_id)
   task_manager.update_task(task_id, status="processing", progress=0.5)
   
   # ❌ 错误 - 不要使用自己的字典
   task_storage[task_id] = {...}
   ```

### 测试

```bash
# 运行linter检查
python -m pylint shared/ router/ --disable=all --enable=E,F

# 测试单个服务
python -m pytest tests/test_document_optimizer.py
python -m pytest tests/test_thesis_checker.py
python -m pytest tests/test_evidence_support.py
```

---

## 总结

### 重构成果

✅ **代码统一**: 消除重复代码60%，核心逻辑集中在shared模块  
✅ **错误处理**: 删除所有fallback机制，使用异常明确报错  
✅ **文档解析**: 统一的3级标题解析逻辑  
✅ **任务管理**: 统一的异步任务状态追踪  
✅ **易于维护**: 新功能开发更快，bug修复更容易  

### 架构优势

1. **模块化**: 共享模块、路由层、业务逻辑层清晰分离
2. **可扩展**: 添加新服务只需创建新router和app
3. **可测试**: 每个模块都可以独立测试
4. **可维护**: 修改一处，所有地方生效
5. **可靠性**: 明确的错误处理，不会静默失败

### 下一步建议

1. 添加单元测试覆盖共享模块
2. 添加API集成测试
3. 实现任务结果的持久化存储
4. 添加性能监控和日志聚合
5. 实现请求限流和负载均衡

---

**文档版本**: 1.0  
**最后更新**: 2025-10-08  
**维护者**: AI Code Refactoring Team

